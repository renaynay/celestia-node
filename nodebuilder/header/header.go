package header

import (
	"context"

	"github.com/celestiaorg/celestia-node/header"
	libhead "github.com/celestiaorg/celestia-node/libs/header"
)

// Module exposes the functionality needed for querying headers from the network.
// Any method signature changed here needs to also be changed in the API struct.
//
//go:generate mockgen -destination=mocks/api.go -package=mocks . Module
type Module interface {
	// LocalHead returns the ExtendedHeader of the chain head.
	LocalHead(context.Context) (*header.ExtendedHeader, error)

	// GetByHash returns the header of the given hash from the node's header store.
	GetByHash(ctx context.Context, hash libhead.Hash) (*header.ExtendedHeader, error)
	// GetVerifiedRangeByHeight returns the given range [from:to) of ExtendedHeaders
	// from the node's header store and verifies that the returned headers are
	// adjacent to each other.
	GetVerifiedRangeByHeight(
		ctx context.Context,
		from *header.ExtendedHeader,
		to uint64,
	) ([]*header.ExtendedHeader, error)
	// GetByHeight returns the ExtendedHeader at the given height, blocking
	// until header has been processed by the store or context deadline is exceeded.
	GetByHeight(context.Context, uint64) (*header.ExtendedHeader, error)

	// IsSyncing returns the status of sync
	IsSyncing(context.Context) bool
	// WaitSync blocks until the header Syncer is synced to network head.
	WaitSync(ctx context.Context) error
	// NetworkHead provides the Syncer's view of the current network head.
	NetworkHead(ctx context.Context) (*header.ExtendedHeader, error)
}

// API is a wrapper around Module for the RPC.
// TODO(@distractedm1nd): These structs need to be autogenerated.
type API struct {
	Internal struct {
		LocalHead func(context.Context) (*header.ExtendedHeader, error) `perm:"read"`
		GetByHash func(
			ctx context.Context,
			hash libhead.Hash,
		) (*header.ExtendedHeader, error) `perm:"public"`
		GetVerifiedRangeByHeight func(
			context.Context,
			*header.ExtendedHeader,
			uint64,
		) ([]*header.ExtendedHeader, error) `perm:"public"`
		GetByHeight func(context.Context, uint64) (*header.ExtendedHeader, error) `perm:"public"`
		IsSyncing   func(context.Context) bool                                    `perm:"read"`
		WaitSync    func(ctx context.Context) error                               `perm:"read"`
		NetworkHead func(ctx context.Context) (*header.ExtendedHeader, error)     `perm:"public"`
	}
}

func (api *API) GetByHash(ctx context.Context, hash libhead.Hash) (*header.ExtendedHeader, error) {
	return api.Internal.GetByHash(ctx, hash)
}

func (api *API) GetVerifiedRangeByHeight(
	ctx context.Context,
	from *header.ExtendedHeader,
	to uint64,
) ([]*header.ExtendedHeader, error) {
	return api.Internal.GetVerifiedRangeByHeight(ctx, from, to)
}

func (api *API) GetByHeight(ctx context.Context, u uint64) (*header.ExtendedHeader, error) {
	return api.Internal.GetByHeight(ctx, u)
}

func (api *API) LocalHead(ctx context.Context) (*header.ExtendedHeader, error) {
	return api.Internal.LocalHead(ctx)
}

func (api *API) IsSyncing(ctx context.Context) bool {
	return api.Internal.IsSyncing(ctx)
}

func (api *API) WaitSync(ctx context.Context) error {
	return api.Internal.WaitSync(ctx)
}

func (api *API) NetworkHead(ctx context.Context) (*header.ExtendedHeader, error) {
	return api.Internal.NetworkHead(ctx)
}
